# 安全运维工程师（知识盒子）

## 纵深防御体系

### 防火墙

#### 优势

简单可靠，规则清晰，阻断彻底，业务侵入低

#### 缺陷无法防护内部攻击

边界防护容易被绕过

安全检测有盲点

### 纵深防护体系框架

安全域划分：公网和内网隔离，内外业务划分

数据链路层隔离：VLAN，vxlan，虚拟化主机

端口协议隔离：防火墙ACL隔离

应用层安全：tomcat、apache加固，sql注入，xss

容器/运行环境：docker加固，解析函数处理

系统层加固：windows、linux加固

内核加固：内核空间防篡改

## 基础安全之自动化安全检查

### nmap使用

nmap -Pn 192.168.19.0/24

## 基础安全之解决弱口令

### 常见技术手段

- 对于Windows的系统，可以利用Windows的域策略，制定密码复杂度的策略。
  - 编辑组策略-计算机配置-Windows配置-安全设置-账户策略-密码策略
- unix系统可以通过LDAP的方式进行集中管理。
  - /etc/login.defs，/etc/security/pwquality.conf
- 高危类服务，例如GIT，SVN等黑客重点目标，可以通过采用SSH密钥的形式进行登录。
- 数据库服务需要进行严格的账户权限控制，及配置加固。
- 动态口令：U盾、手机终端验证、生物特征识别

## 基础安全之端口安全

- \1. 及时关闭不需要使用的服务及其端口，检查监听地址是否为0.0.0.0
- \2. 定期扫描主机端口开放情况
- \3. 配置硬件设备（硬件防火墙）阻隔敏感端口

## 防火墙

### 分类

主机防火墙：针对单个主机进行防护

网络防火墙：处于网络入口或边缘，针对网络入口进行防护

### 软件防火墙工作原理

包过滤：对主机的数据包进行筛选和过滤

规则匹配：放行( accept)、拒绝( reject))和丢弃(drop)

配置规则：添加、删除或者修改规则

### iptables四张表

raw 高级功能，如网址过滤

mangle 数据包修改

nat 网络地址转换

filter 包过滤，用于防火墙拦截规则、过滤数据包

### iptables命令栗子

```
iptables -A INPUT -p tcp --dport 80 -j DROP
拒绝所有访问80端口的数据包

iptables -I INPUT -p tcp -s 192.168.19.1 --dport 80 -j ACCEPT
仅允许192.168.19.1访问80端口的数据包
iptables -I INPUT -p tcp -s 192.168.19.1/24 --dport 80 -j ACCEPT
允许整个192.168.19网段访问
```

# 防火墙

## iptables

### 命令行使用

```
iptables -t 表名 <-A/I/D/R> 规则链名 [规则号] <-i/o 网卡名> -p 协议名 <-s 源IP/源子网> --sport 源端口 <-d 目标IP/目标子网> --dport 目标端口 -j 动作
表名包括：

raw：高级功能，如：网址过滤。
mangle：数据包修改（QOS），用于实现服务质量。
net：地址转换，用于网关路由器。
filter：包过滤，用于防火墙规则。

规则链名包括：
INPUT链：处理输入数据包。
OUTPUT链：处理输出数据包。
PORWARD链：处理转发数据包。
PREROUTING链：用于目标地址转换（DNAT）。
POSTOUTING链：用于源地址转换（SNAT）.

动作包括：
accept：接收数据包。
DROP：丢弃数据包。
REDIRECT：重定向、映射、透明代理。
SNAT：源地址转换。
DNAT：目标地址转换。
MASQUERADE：IP伪装（NAT），用于ADSL。
LOG：日志记录。

-t<表>：指定要操纵的表；
-A：向规则链中添加条目；
-D：从规则链中删除条目；
-i：向规则链中插入条目；
-R：替换规则链中的条目；
-L：显示规则链中已有的条目；
-F：清楚规则链中已有的条目；
-Z：清空规则链中的数据包计算器和字节计数器；
-N：创建新的用户自定义规则链；
-P：定义规则链中的默认目标；
-h：显示帮助信息；
-p：指定要匹配的数据包协议类型；
-s：指定要匹配的数据包源ip地址；
-j<目标>：指定要跳转的目标；
-i<网络接口>：指定数据包进入本机的网络接口；
-o<网络接口>：指定数据包要离开本机所使用的网络接口。
```

### 链

iptables中存在5个链：prerouting路由前，input主机web服务的输入，output主机web服务的输出，forward转发，postrouting路由后

链的意思是，在这5个“关卡”上配备的规则，需要全部符合才能执行相关操作

### 表

#### 4种表：filter、nat、mangle、raw

filter：过滤

nat网络地址转换

mangle：拆解报文，做出修改，重新封装

raw：关闭nat表上弃用的连接追踪机制

#### 表和链

实际操作中，以表为主

链的规则只能存在某几类表中

# CTF

## Web

### XSS

#### 典型套路[1]

给管理员发一条留言好吗——XSS

提交网站漏洞，只限本站内的url，管理员会后台查看——反射型&DOM XSS

动态执行JS语句，更改DOM树结构——DOM XSS

加载图片处、编辑用户名处——反射性XSS

缓存投毒XSS——获取管理员Cookie

Bypass CSP——获取管理员Cookie

XSS to RCE——获取系统flag

### SSRF

#### 定义[1]

服务器端请求伪造 server-side request forgery

由攻击者构造形成由服务端发起请求的一个安全漏洞，目标一般是从外网无法访问的系统

#### 成因[1]

都是由于服务端提供了从其他服务器应用获取数据的功能且没有对目标地址做过滤与限制。

也就是说，对于为服务器提供服务的其他应用没有对访问进行限制，如果我构造好我的访问包，那我就有可能利用目标服务对他的其他服务器应用进行调用。

### XXE

### 文件上传

### 文件包含

### SSTI模板注入

### SQL、NOSQL注入漏洞

# Bandit

## level 0

考察SSH

方法1：Linux命令行

```
ssh bandit.labs.overthewire.org -p 2220 -l bandit0
```

在建立链接后输出密码

方法2：使用putty

## level1 

考察文件名为-时，怎么使用cat

由于惯例，-为文件名时一般作为标准输入输出使用。因此想要使用，需要./-或者 < -进行使用

方法1

```
cat < -
```



方法2

```
cat ./-
```

## level2

考察如何显示文件名带空格的文件

```
cat "spaces in this filename"
```

## level3

考察如何查看隐藏文件

```
ls -la
```

## level4

方法1：

遍历一下inhere下每个文件，找到不是乱码的那个就可以

方法2：

```
file ./-file*
```

## level5

考察find的用法

```
-name filename 查找名为filename的文件
-type b/d/c/p/l/f 查找是块设备、目录、字符设备、管道、符号链接、普通文件
-size n[c] 查找长度为n块【或n字节】的文件
-user -username 按文件属主查找
-group groupname 按组查找
```

写法

```
find -type f -size 1033c
```

## level6

继续考察find的用法

```
find -size 33c -group bandit6 -user bandit7
```

## level7

考察grep

```
cat data.txt | grep millionth
```

## level8

考察sort、uniq

```
uniq 只对相邻行有空的重复判断，常与sort结合使用
-c或者--count 显示该行重复的次数
-d或者--repeat 仅显示重复出现的列
-u或者--unique 仅显示出一次的列
```

写法

```
cat data.txt | sort | uniq -u
```

## level9

考察strings

```
strings用于识别在对象文件或二进制文件中的可打印字符串
```



```
strings data.txt | grep "="
```

## level 10

考察base64

-d表示解码

```
cat data.txt | base64 -d
```

## level 11

考察tr用法，用于转换或删除字符

```
 cat data.txt | tr '[A-Za-z]' '[N-ZA-Mn-za-m]'
```

## level 12

考察file、bzip2、tar、zcat

1. file 可以看到文件类型
2. bzip2 -d 解压bzip2格式压缩包
3. zcat a.out >b 将gzip压缩格式数据解压成b
4. tar -xvf 解压tar格式压缩包

```
file data
data: bzip2 compressed data, block size = 900k
bzip2 -d data
bzip2: Can't guess original name for data -- using data.out
file data.out
data.out: gzip compressed data, was "data4.bin", from Unix, last modified: Thu Jun 6 13:59:43 2013, max compression
zcat data.out > data3
file data3
data3: POSIX tar archive (GNU)
tar -xvf data3
data5.bin
file data5.bin
data5.bin: POSIX tar archive (GNU)
tar -xvf data5.bin
data6.bin
file data6.bin
bzip2 -d data6.bin
bzip2: Can't guess original name for data6.bin -- using data6.bin.out
file data6.bin.out
data6.bin.out: POSIX tar archive (GNU)
tar -xvf data6.bin.out
data8.bin
file data8.bin
data8.bin: gzip compressed data, was "data9.bin", from Unix, last modified: Thu Jun  6 13:59:43 2013, max compression
zcat data8.bin > data9.bin
file data9.bin
data9.bin: ASCII text
cat data9.bin
8ZjyCRiBWFYkneahHwxCv3wb2a1ORpYL

```



## level 13

考察使用私钥文件建立ssh的方法

```
ssh -i sshkey.private -l bandit14 localhost
```

## level 14

考察nc

1. 与某处建立连接 nc hostname port
2. 监听：nc -l -p port

```
nc localhost 30000 < /etc/bandit_pass/bandit14
```



# 参考

[1]知识盒子-网络控件安全竞技CTF